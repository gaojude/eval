/**
 * Shared utilities for agent implementations.
 */

import type { ScriptResult } from './types.js';
import type { SandboxManager } from '../sandbox.js';

/**
 * Combined validation results.
 */
export interface ValidationResults {
  allPassed: boolean;
  test?: ScriptResult;
  scripts: Record<string, ScriptResult>;
}

/**
 * Run validation scripts in the sandbox.
 */
export async function runValidation(
  sandbox: SandboxManager,
  scripts: string[]
): Promise<ValidationResults> {
  const results: ValidationResults = {
    allPassed: true,
    scripts: {},
  };

  // Always run vitest for EVAL.ts (explicitly specify the file)
  const testResult = await sandbox.runCommand('npx', ['vitest', 'run', 'EVAL.ts']);
  results.test = {
    success: testResult.exitCode === 0,
    output: testResult.stdout + testResult.stderr,
  };
  if (!results.test.success) {
    results.allPassed = false;
  }

  // Run configured scripts
  for (const script of scripts) {
    const scriptResult = await sandbox.runCommand('npm', ['run', script]);
    const result: ScriptResult = {
      success: scriptResult.exitCode === 0,
      output: scriptResult.stdout + scriptResult.stderr,
    };

    results.scripts[script] = result;

    if (!result.success) {
      results.allPassed = false;
    }
  }

  return results;
}

/**
 * Capture source files generated by the agent.
 */
export async function captureGeneratedFiles(sandbox: SandboxManager): Promise<Record<string, string>> {
  const files: Record<string, string> = {};

  try {
    // Find all source files
    const findResult = await sandbox.runShell(
      "find . -path './node_modules' -prune -o \\( -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' \\) -type f -print"
    );

    const filePaths = findResult.stdout
      .trim()
      .split('\n')
      .filter(Boolean);

    for (const filePath of filePaths) {
      try {
        const content = await sandbox.readFile(filePath);
        files[filePath] = content;
      } catch {
        // Skip unreadable files
      }
    }
  } catch {
    // If capture fails, return empty object
  }

  return files;
}

/**
 * Create vitest config for running EVAL.ts.
 */
export async function createVitestConfig(sandbox: SandboxManager): Promise<void> {
  await sandbox.writeFiles({
    'vitest.config.ts': `
import { defineConfig } from 'vitest/config';
export default defineConfig({
  test: {
    include: ['EVAL.ts'],
    globals: false,
  },
});
`,
  });
}

/**
 * AI Gateway configuration.
 */
export const AI_GATEWAY = {
  baseUrl: 'https://ai-gateway.vercel.sh',
  openAiBaseUrl: 'https://ai-gateway.vercel.sh/v1',
  apiKeyEnvVar: 'AI_GATEWAY_API_KEY',
} as const;
